<!doctype html>
<html>
  <body>
    <script src="three.js"></script>
    <script>
let canvas, context, fbo, camera, iframe, isMacOs;

function init() {
  canvas = document.createElement('canvas');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  context = canvas.getContext('webgl');
  
  fbo = context.createFramebuffer();
  
  document.body.appendChild(canvas);

  iframe = document.createElement('iframe');
  iframe.d = 2;
  iframe.src = 'examples/launcher_interface.html';
  iframe.onload = () => {
    iframe.contentWindow.onmessage = m => {
      console.log('parent got message: ' + JSON.stringify(m.data));
    };

    iframe.runJs(`
      // document.body.style.background = '#000080';
      // console.log('run js log ' + typeof window.postMessage + ' ' + window.postMessage.toString());

      window.onmessage = m => {
        console.log('child got message: ' + JSON.stringify(m.data));
      };

      window.postMessage({lol: 'zol'});
    `);

    console.log('post message 1');
    iframe.contentWindow.postMessage({
      woot: 'toot',
    });
    console.log('post message 2');
  };
  iframe.onconsole = (message, source, line) => {
    console.log(source + ':' + line + ': ' + message);
  };
  document.body.appendChild(iframe);

  focused = true;

  window.addEventListener('mousemove', e => {
    iframe.sendMouseMove(e.clientX, e.clientY);
  });
  window.addEventListener('mousedown', e => {
    iframe.sendMouseDown(e.clientX, e.clientY, e.button); 

    focused = true;
  });
  window.addEventListener('mouseup', e => {
    iframe.sendMouseUp(e.clientX, e.clientY, e.button);
  });
  window.addEventListener('wheel', e => {
    if (focused) {
      iframe.sendMouseWheel(e.clientX, e.clientY, e.deltaX, -e.deltaY);
    }
  });
  window.addEventListener('keydown', e => {
    if (focused) {
      if (e.keyCode === 37 && e.altKey) { // Alt-Left
        iframe.back();
      } else if (e.keyCode === 39 && e.altKey) { // Alt-Right
        iframe.forward();
      } else {
        iframe.sendKeyDown(e.keyCode,{shiftKey:e.shiftKey,ctrlKey:e.ctrlKey,altKey:e.altKey});
      }
    }
  });
  window.addEventListener('keyup', e => {
    if (focused) {
      iframe.sendKeyUp(e.keyCode,{shiftKey:e.shiftKey,ctrlKey:e.ctrlKey,altKey:e.altKey});
    }
  });
  window.addEventListener('keypress', e => {
    if (focused) {
      if (e.keyCode === 114 && e.ctrlKey) { // Ctrl-R
        iframe.reload();
      } else {
        iframe.sendKeyPress(e.keyCode,{shiftKey:e.shiftKey,ctrlKey:e.ctrlKey,altKey:e.altKey});
      }
    }
  });

  isMacOs = /darwin/.test(navigator.userAgent);
}

init();

function animate(timestamp, frame) {
  window.requestAnimationFrame(animate);

  context.bindFramebuffer(context.READ_FRAMEBUFFER, fbo);
  context.framebufferTexture2D(context.READ_FRAMEBUFFER, context.COLOR_ATTACHMENT0, context.TEXTURE_2D, iframe.browser.texture, 0);

  context.bindFramebuffer(context.DRAW_FRAMEBUFFER, 0);

  /* context.clearColor(1, 0, 0, 1);
  context.clear(context.COLOR_BUFFER_BIT); */

  const delta = isMacOs ? -245 : 0;
  context.blitFramebuffer(0, 0, canvas.width, canvas.height, 0, canvas.height + delta, canvas.width, delta, context.COLOR_BUFFER_BIT, context.LINEAR);

  context.finish();
}
window.requestAnimationFrame(animate);

/* if (navigator.xr) {
  (async () => {
    display = await navigator.xr.requestDevice();
    const session = await display.requestSession({
      exclusive: true,
    });
    display.session = session;

    session.onselect = e => {
      console.log('select'); // XXX
    };

    session.requestAnimationFrame((timestamp, frame) => {
      renderer.vr.setSession(session, {
        frameOfReferenceType: 'stage',
      });

      const viewport = session.baseLayer.getViewport(frame.views[0]);
      const width = viewport.width;
      const height = viewport.height;

      renderer.setSize(width * 2, height);

      renderer.setAnimationLoop(null);

      renderer.vr.enabled = true;
      renderer.vr.setDevice(display);
      renderer.vr.setAnimationLoop(animate);

      console.log('running!');
    });
  })()
    .catch(err => {
      console.warn(err.stack);
    });
} else {
  renderer.setAnimationLoop(animate);
} */

    </script>
  </body>
</html>
